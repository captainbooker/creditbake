<div class="mx-auto max-w-screen-2xl p-4 md:p-6 2xl:p-10">
  <div class="max-w-7xl mx-auto p-6">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">Credit Scores</h1>
      <%= link_to 'Create Attack', letters_path, class: "bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-700" %>
    </div>
    <hr class="mb-6">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <div class="score-card">
        <div class="score-circle">
          <svg viewBox="0 0 100 100" class="w-full h-full">
            <circle class="text-gray-300" stroke-width="10" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" />
            <circle id="transunion-progress" class="text-red-500" stroke-width="10" stroke-dasharray="251.2" stroke-dashoffset="251.2" stroke-linecap="round" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" />
          </svg>
          <div id="transunion-score-text" class="score-text">0</div>
        </div>
        <p id="transunion-score-indicator" class="score-indicator">Import Credit Report</p>
        <p class="updated-date">Updated <%= @credit_report&.created_at&.strftime("%m/%d/%Y") %></p>
        <p class="font-semibold">TransUnion</p>
      </div>

      <div class="score-card">
        <div class="score-circle">
          <svg viewBox="0 0 100 100" class="w-full h-full">
            <circle class="text-gray-300" stroke-width="10" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" />
            <circle id="experian-progress" class="text-red-500" stroke-width="10" stroke-dasharray="251.2" stroke-dashoffset="251.2" stroke-linecap="round" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" />
          </svg>
          <div id="experian-score-text" class="score-text">0</div>
        </div>
        <p id="experian-score-indicator" class="score-indicator">Import Credit Report</p>
        <p class="updated-date">Updated <%= @credit_report&.created_at&.strftime("%m/%d/%Y") %></p>
        <p class="font-semibold">Experian</p>
      </div>

      <div class="score-card">
        <div class="score-circle">
          <svg viewBox="0 0 100 100" class="w-full h-full">
            <circle class="text-gray-300" stroke-width="10" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" />
            <circle id="equifax-progress" class="text-yellow-500" stroke-width="10" stroke-dasharray="251.2" stroke-dashoffset="251.2" stroke-linecap="round" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" />
          </svg>
          <div id="equifax-score-text" class="score-text">0</div>
        </div>
        <p id="equifax-score-indicator" class="score-indicator">Import Credit Report</p>
        <p class="updated-date">Updated <%= @credit_report&.created_at&.strftime("%m/%d/%Y") %></p>
        <p class="font-semibold">Equifax</p>
      </div>
    </div>
    
    <!-- New Section -->
    <div class="mt-8">
      <h2 class="text-xl font-semibold mb-6">Credit Summary</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="flex flex-col items-center justify-between border p-4 rounded-lg shadow-md bg-white">
          <div class="flex flex-col items-center">
            <div class="text-sm font-medium font-semibold text-gray-700">Open Accounts</div>
            <div class="text-3xl font-semibold text-red-500"><%= @accounts.count %></div>
          </div>
          <div class="mt-4">
            <%= link_to 'Take Action', '#', class: "px-6 py-3 font-medium rounded-lg transition duration-300 #{ 'bg-gray-400 text-gray-700 cursor-not-allowed' if @accounts.count.zero? } #{ 'bg-blue-500 text-white hover:bg-blue-700' unless @accounts.count.zero? }", disabled: @accounts.count.zero? %>
          </div>
        </div>

        <div class="flex flex-col items-center justify-between border p-4 rounded-lg shadow-md bg-white">
          <div class="flex flex-col items-center">
            <div class="text-sm font-medium font-semibold text-gray-700">Hard Inquiries</div>
            <div class="text-3xl font-semibold text-red-500"><%= @inquiries.count %></div>
          </div>
          <div class="mt-4">
            <%= link_to 'Take Action', '#', class: "px-6 py-3 font-medium rounded-lg transition duration-300 #{ 'bg-gray-400 text-gray-700 cursor-not-allowed' if @inquiries.count.zero? } #{ 'bg-blue-500 text-white hover:bg-blue-700' unless @inquiries.count.zero? }", disabled: @inquiries.count.zero? %>
          </div>
        </div>

        <div class="flex flex-col items-center justify-between border p-4 rounded-lg shadow-md bg-white">
          <div class="flex flex-col items-center">
            <div class="text-sm font-medium font-semibold text-gray-700">Negative Accounts</div>
            <div class="text-3xl font-semibold text-red-500"><%= @negative_accounts.count %></div>
          </div>
          <div class="mt-4">
            <%= link_to 'Take Action', '#', class: "px-6 py-3 font-medium rounded-lg transition duration-300 #{ 'bg-gray-400 text-gray-700 cursor-not-allowed' if @negative_accounts.count.zero? } #{ 'custom-blue text-white hover:bg-blue-700' unless @negative_accounts.count.zero? }", disabled: @negative_accounts.count.zero? %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="flex items-center justify-between mb-6 mt-6">
    <h1 class="text-2xl font-bold">Generated Letters</h1>
  </div>

  <div class="mt-8 flow-root">
    <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
      <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
        <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 sm:rounded-lg">
          <table class="min-w-full divide-y divide-gray-300">
            <thead class="custom-blue md:bg-gray-50 rounded-t-lg shadow-lg">
              <tr>
                <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-white md:text-gray-900 sm:pl-6">Name</th>
                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-white md:text-gray-900">File Count</th>
                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-white md:text-gray-900">Created At</th>
                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-white md:text-gray-900"></th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 bg-white">
              <% @letters.each do |letter| %>
                <tr data-letter-id="<%= letter.id %>" data-total-pages="<%= letter.total_pages %>" data-experian-pdf="<%= letter.experian_pdf.attached? %>" data-transunion-pdf="<%= letter.transunion_pdf.attached? %>" data-equifax-pdf="<%= letter.equifax_pdf.attached? %>">
                  <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6"><%= letter.name %></td>
                  <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500"><%= [letter.experian_pdf, letter.transunion_pdf, letter.equifax_pdf].compact.count %></td>
                  <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500"><%= letter.created_at.strftime("%m/%d/%Y") %></td>
                  <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                    <div class="flex flex-col sm:flex-row sm:justify-end items-start sm:items-center">
                      <button class="text-white bg-black px-4 py-2 rounded hover:bg-opacity-90 mb-2 sm:mb-0 sm:mr-2" onclick="downloadAllFiles('<%= letter.id %>')">Download All Files</button>
                      <% if letter.mailed? %>
                        <div class="text-green-500 sm:ml-4 mb-2 sm:mb-0">Mailed</div>
                        <div class="text-gray-500 sm:ml-4 mb-2 sm:mb-0">
                          Tracking Numbers:
                          <ul>
                            <% if letter.experian_tracking_number.present? %>
                              <li>Experian: <%= letter.experian_tracking_number %></li>
                            <% end %>
                            <% if letter.transunion_tracking_number.present? %>
                              <li>TransUnion: <%= letter.transunion_tracking_number %></li>
                            <% end %>
                            <% if letter.equifax_tracking_number.present? %>
                              <li>Equifax: <%= letter.equifax_tracking_number %></li>
                            <% end %>
                          </ul>
                        </div>
                      <% else %>
                        <button class="text-white bg-blue-500 px-4 py-2 rounded hover:bg-blue-600 sm:ml-2" onclick="showMailModal('<%= letter.id %>')">Mail</button>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
          <div class="px-4 py-3 bg-gray-50 text-right sm:px-6">
            <%= paginate @letters %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
document.addEventListener("turbolinks:load", function() {
  const scoreRanges = [
    { min: 300, max: 579, label: 'Poor', color: 'text-red-500' },
    { min: 580, max: 669, label: 'Fair', color: 'text-yellow-500' },
    { min: 670, max: 739, label: 'Good', color: 'text-green-500' },
    { min: 740, max: 799, label: 'Very Good', color: 'text-blue-500' },
    { min: 800, max: 850, label: 'Excellent', color: 'text-purple-500' }
  ];

  function getColorAndLabel(score) {
    for (let range of scoreRanges) {
      if (score >= range.min && score <= range.max) {
        return { color: range.color, label: range.label };
      }
    }
    return { color: 'text-gray-500', label: 'Unknown' };
  }

  function setProgress(elementId, score, maxScore = 850) {
    const element = document.getElementById(elementId);
    const percent = (score / maxScore) * 100;
    const dashOffset = 251.2 - (percent / 100) * 251.2;

    element.style.strokeDashoffset = dashOffset;
    
    // Animate the strokeDashoffset
    element.animate([
      { strokeDashoffset: 251.2 },
      { strokeDashoffset: dashOffset }
    ], {
      duration: 2000,
      easing: 'ease-out',
      fill: 'forwards'
    });
  }

  async function fetchScores() {
    try {
      const response = await fetch('/credit_reports/scores');
      const data = await response.json();
      return data;
    } catch (error) {
      console.error('Error fetching scores:', error);
      return { experian_score: 0, transunion_score: 0, equifax_score: 0 };
    }
  }

  fetchScores().then(scores => {
    if (scores.experian_score) {
      const { color, label } = getColorAndLabel(scores.experian_score);
      document.getElementById('experian-score-text').textContent = scores.experian_score;
      document.getElementById('experian-score-text').parentElement.classList.add(color);
      document.getElementById('experian-score-text').parentElement.nextElementSibling.textContent = label;
      setProgress('experian-progress', scores.experian_score, 800);
    }

    if (scores.transunion_score) {
      const { color, label } = getColorAndLabel(scores.transunion_score);
      document.getElementById('transunion-score-text').textContent = scores.transunion_score;
      document.getElementById('transunion-score-text').parentElement.classList.add(color);
      document.getElementById('transunion-score-text').parentElement.nextElementSibling.textContent = label;
      setProgress('transunion-progress', scores.transunion_score, 800);
    }

    if (scores.equifax_score) {
      const { color, label } = getColorAndLabel(scores.equifax_score);
      document.getElementById('equifax-score-text').textContent = scores.equifax_score;
      document.getElementById('equifax-score-text').parentElement.classList.add(color);
      document.getElementById('equifax-score-text').parentElement.nextElementSibling.textContent = label;
      setProgress('equifax-progress', scores.equifax_score, 800);
    }
  });
});
</script>